From 38a49b6342027ef1f0052f6ef2074cb8a1b06fca Mon Sep 17 00:00:00 2001
From: Roberto Luiz Martins Nogueira
 <robertoluiz.martinsnogueira@windriver.com>
Date: Sun, 7 Nov 2021 10:31:04 -0300
Subject: [PATCH] Roll-up-TIS-patches

Signed-off-by: Roberto Luiz Martins Nogueira <robertoluiz.martinsnogueira@windriver.com>
---
 manifests/params.pp        | 2 +-
 manifests/server/config.pp | 6 ++++++
 manifests/server/initdb.pp | 9 +++++++++
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/manifests/params.pp b/manifests/params.pp
index 15b72bd..9e72600 100644
--- a/manifests/params.pp
+++ b/manifests/params.pp
@@ -144,7 +144,7 @@ class postgresql::params inherits postgresql::globals {
       $confdir                = pick($confdir, $datadir)
       $psql_path              = pick($psql_path, "${bindir}/psql")
 
-      $service_status         = $service_status
+      $service_status         = "systemctl is-active postgresql"
       $service_reload         = "systemctl reload ${service_name}"
       $python_package_name    = pick($python_package_name, 'python-psycopg2')
       # Archlinux does not have a perl::DBD::Pg package
diff --git a/manifests/server/config.pp b/manifests/server/config.pp
index 93bc9b9..e5f44e1 100644
--- a/manifests/server/config.pp
+++ b/manifests/server/config.pp
@@ -149,6 +149,12 @@ class postgresql::server::config {
   postgresql::server::config_entry { 'data_directory':
     value => $datadir,
   }
+  postgresql::server::config_entry { 'hba_file':
+    value => $pg_hba_conf_path,
+  }
+  postgresql::server::config_entry { 'ident_file':
+    value => $pg_ident_conf_path,
+  }
   if $timezone {
     postgresql::server::config_entry { 'timezone':
       value => $timezone,
diff --git a/manifests/server/initdb.pp b/manifests/server/initdb.pp
index a73186d..7ab7912 100644
--- a/manifests/server/initdb.pp
+++ b/manifests/server/initdb.pp
@@ -3,6 +3,7 @@ class postgresql::server::initdb {
   $needs_initdb   = $postgresql::server::needs_initdb
   $initdb_path    = $postgresql::server::initdb_path
   $datadir        = $postgresql::server::datadir
+  $confdir        = $postgresql::server::confdir
   $xlogdir        = $postgresql::server::xlogdir
   $logdir         = $postgresql::server::logdir
   $manage_datadir = $postgresql::server::manage_datadir
@@ -56,6 +57,14 @@ class postgresql::server::initdb {
     }
   }
 
+  # Make sure the conf directory exists, and has the correct permissions.
+  file { $confdir:
+    ensure => directory,
+    owner  => $user,
+    group  => $group,
+    mode   => '0700',
+  }
+
   if($xlogdir) {
     if($manage_xlogdir) {
       # Make sure the xlog directory exists, and has the correct permissions.
-- 
2.17.1

