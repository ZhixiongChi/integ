From f4baa299dbd842494e40f46ce7b29d20aaf6acab Mon Sep 17 00:00:00 2001
From: Dan Voiculeasa <dan.voiculeasa@windriver.com>
Date: Wed, 15 Sep 2021 16:27:35 +0300
Subject: [PATCH] Adapt first set of legacy patches

Adapt 0001-Roll-up-TIS-patches.patch from CentOS.

Signed-off-by: Dan Voiculeasa <dan.voiculeasa@windriver.com>
---
 manifests/server/config.pp | 9 +++++++++
 manifests/server/initdb.pp | 9 +++++++++
 2 files changed, 18 insertions(+)

diff --git a/manifests/server/config.pp b/manifests/server/config.pp
index 93bc9b9..cc4bffd 100644
--- a/manifests/server/config.pp
+++ b/manifests/server/config.pp
@@ -149,6 +149,15 @@ class postgresql::server::config {
   postgresql::server::config_entry { 'data_directory':
     value => $datadir,
   }
+
+  postgresql::server::config_entry { 'hba_file':
+    value => $pg_hba_conf_path,
+  }
+
+  postgresql::server::config_entry { 'ident_file':
+    value => $pg_ident_conf_path,
+  }
+
   if $timezone {
     postgresql::server::config_entry { 'timezone':
       value => $timezone,
diff --git a/manifests/server/initdb.pp b/manifests/server/initdb.pp
index a73186d..8f90f6f 100644
--- a/manifests/server/initdb.pp
+++ b/manifests/server/initdb.pp
@@ -5,6 +5,7 @@ class postgresql::server::initdb {
   $datadir        = $postgresql::server::datadir
   $xlogdir        = $postgresql::server::xlogdir
   $logdir         = $postgresql::server::logdir
+  $confdir        = $postgresql::server::confdir
   $manage_datadir = $postgresql::server::manage_datadir
   $manage_logdir  = $postgresql::server::manage_logdir
   $manage_xlogdir = $postgresql::server::manage_xlogdir
@@ -56,6 +57,14 @@ class postgresql::server::initdb {
     }
   }
 
+  # Make sure the conf directory exists, and has the correct permissions.
+  file { $confdir:
+    ensure => directory,
+    owner  => $user,
+    group  => $group,
+    mode   => '0700',
+  }
+
   if($xlogdir) {
     if($manage_xlogdir) {
       # Make sure the xlog directory exists, and has the correct permissions.
-- 
2.30.0

